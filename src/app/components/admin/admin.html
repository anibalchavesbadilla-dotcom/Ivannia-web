<div class="container py-5">

  <h2 class="fw-bold mb-4 text-center">Panel de Administración</h2>

  <div *ngIf="loading" class="text-center">
    <div class="spinner-border"></div>
    <p>Cargando…</p>
  </div>

  <div *ngIf="error" class="alert alert-danger text-center">{{ error }}</div>
  <div *ngIf="success" class="alert alert-success text-center">Cambios guardados ✔️</div>

  <form *ngIf="!loading" class="mb-5">

    <!-- SECCIONES NORMALES ------------------------------------------->
    <ng-container *ngFor="let section of data">

      <!-- NO dibujar servicios ni proyectos en esta parte -->
      <ng-container *ngIf="section.key !== 'servicios' && section.key !== 'proyectos'">

        <div class="card mb-4 shadow-sm rounded-4">
          <div class="card-header bg-primary text-white rounded-top-4">
            <h5 class="mb-0">{{ section.key }}</h5>
          </div>

          <div class="card-body">

            <!-- OBJETO -->
            <ng-container *ngIf="isObject(section.value)">
              <ng-container *ngFor="let sub of castRecord(section.value) | keyvalue">

                <!-- Campo simple -->
                <div *ngIf="!isObject(sub.value) && !isArray(sub.value)" class="mb-3">
                  <label class="fw-semibold">{{ sub.key }}</label>
                  <input class="form-control form-control-lg"
                         [(ngModel)]="data[section.key][sub.key]"
                         name="{{ section.key }}-{{ sub.key }}">
                </div>

                <!-- Objeto anidado -->
                <div *ngIf="isObject(sub.value)" class="p-3 border rounded-4 mb-3 bg-light">
                  <h6 class="fw-bold">{{ sub.key }}</h6>

                  <ng-container *ngFor="let deep of castRecord(sub.value) | keyvalue">
                    <label>{{ deep.key }}</label>
                    <input class="form-control mb-2"
                           [(ngModel)]="data[section.key][sub.key][deep.key]"
                           name="{{ section.key }}-{{ sub.key }}-{{ deep.key }}">
                  </ng-container>

                </div>

              </ng-container>
            </ng-container>
          </div>
        </div>

      </ng-container>

    </ng-container>


    <!-- SERVICIOS ---------------------------------------------------->
    <div class="d-flex justify-content-between align-items-center my-4">
      <h3 class="fw-bold">Servicios</h3>
      <button type="button" class="btn btn-success" (click)="addService()">+ Agregar Servicio</button>
    </div>

    <div *ngFor="let service of castArray(data.servicios); let i = index" class="card mb-4 shadow-sm rounded-4">
      <div class="card-header bg-secondary text-white d-flex justify-content-between rounded-top-4">
        <h5 class="mb-0">Servicio {{ i + 1 }}</h5>
        <button class="btn btn-danger btn-sm" (click)="removeService(i)">Eliminar</button>
      </div>

      <div class="card-body">

        <ng-container *ngFor="let field of castRecord(service) | keyvalue">

          <!-- Videos es un array -->
          <ng-container *ngIf="field.key === 'Videos'">
            <h6 class="fw-bold mt-3">Videos</h6>

            <div *ngFor="let v of field.value; let vi = index" class="input-group mb-2">
              <input class="form-control" [(ngModel)]="data.servicios[i].Videos[vi].url"
                     name="serv-{{i}}-video-{{vi}}">
              <button class="btn btn-outline-danger" (click)="removeVideo(service, vi)">X</button>
            </div>

            <button class="btn btn-outline-primary btn-sm" (click)="addVideo(service)">+ Agregar Video</button>
            <hr>
          </ng-container>

          <!-- Campos normales -->
          <ng-container *ngIf="field.key !== 'Videos'">
            <label class="fw-semibold">{{ field.key }}</label>
            <input class="form-control mb-3"
                   [(ngModel)]="data.servicios[i][field.key]"
                   name="serv-{{i}}-{{field.key}}">
          </ng-container>

        </ng-container>

      </div>
    </div>



    <!-- PROYECTOS ----------------------------------------------------->
    <div class="d-flex justify-content-between align-items-center my-4">
      <h3 class="fw-bold">Proyectos</h3>
      <button type="button" class="btn btn-success" (click)="addProyecto()">+ Agregar Proyecto</button>
    </div>

    <div *ngFor="let pro of castArray(data.proyectos); let p = index" class="card mb-4 shadow-sm rounded-4">
      <div class="card-header bg-dark text-white d-flex justify-content-between rounded-top-4">
        <h5 class="mb-0">Proyecto {{ p + 1 }}</h5>
        <button class="btn btn-danger btn-sm" (click)="removeProyecto(p)">Eliminar</button>
      </div>

      <div class="card-body">

        <ng-container *ngFor="let field of castRecord(pro) | keyvalue">

          <!-- Videos -->
          <ng-container *ngIf="field.key === 'Videos'">
            <h6 class="fw-bold mt-3">Videos</h6>

            <div *ngFor="let v of field.value; let vi = index" class="input-group mb-2">
              <input class="form-control" [(ngModel)]="data.proyectos[p].Videos[vi].url"
                     name="proj-{{p}}-video-{{vi}}">
              <button class="btn btn-outline-danger" (click)="removeVideo(pro, vi)">X</button>
            </div>

            <button class="btn btn-outline-primary btn-sm" (click)="addVideo(pro)">+ Agregar Video</button>
            <hr>
          </ng-container>

          <!-- Campos normales -->
          <ng-container *ngIf="field.key !== 'Videos'">
            <label class="fw-semibold">{{ field.key }}</label>
            <input class="form-control mb-3"
                   [(ngModel)]="data.proyectos[p][field.key]"
                   name="proj-{{p}}-{{field.key}}">
          </ng-container>

        </ng-container>

      </div>

    </div>


    <!-- BOTÓN GUARDAR -------------------------------------------------->
    <div class="text-center mt-5">
      <button class="btn btn-primary btn-lg px-5" type="button" (click)="guardar()">Guardar Cambios</button>
    </div>

  </form>

</div>
